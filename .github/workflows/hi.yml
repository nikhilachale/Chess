- name: Deploy using Docker Compose
  run: |
    ssh -i ~/.ssh/deploy_key \
        -o StrictHostKeyChecking=no \
        -o ConnectTimeout=30 \
        -o ServerAliveInterval=10 \
        -o ServerAliveCountMax=3 \
        ec2-user@3.110.54.252 << 'EOF'
    set -e
    echo "âœ… Connected to server"

    echo "ðŸ“ Navigating to project directory..."
    cd ~/Chess || { echo "âŒ Project directory not found"; exit 1; }

    echo "ðŸ“¥ Pulling latest code..."
    git pull origin main

    echo "ðŸ›‘ Stopping existing containers..."
    docker-compose down || true

    echo "ðŸ”„ Starting containers with latest images..."
    docker-compose up -d --pull always

    echo "â³ Waiting for containers to start..."
    sleep 10

    echo "ðŸ“Š Container status:"
    docker-compose ps

    echo "ðŸ” Checking container health..."
    if docker ps --filter "name=chess-ui" --filter "status=running" | grep -q chess-ui; then
      echo "âœ… UI container is running"
    else
      echo "âŒ UI container failed to start"
      docker logs chess-ui --tail 20
    fi

    if docker ps --filter "name=chess-ws" --filter "status=running" | grep -q chess-ws; then
      echo "âœ… WebSocket container is running"
    else
      echo "âŒ WebSocket container failed to start"
      docker logs chess-ws --tail 20
    fi

    echo "ðŸŽ‰ Chess app deployed successfully!"
    EOF